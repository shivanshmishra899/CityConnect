<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransitFlow - Real-Time Bus Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }

        .hidden {
            display: none;
        }

        #map {
            height: 100vh;
            width: 100vw;
            z-index: 0;
        }

        .bus-icon-div {
            width: 36px;
            height: 36px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 2px solid #4285F4;
        }

        .bus-stop-icon-div {
            width: 14px;
            height: 14px;
            background-color: rgba(0, 0, 0, 0.7);
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .auth-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .role-toggle-btn {
            transition: all 0.3s ease;
        }

        .role-toggle-btn.active {
            background-color: white;
            color: #4f46e5;
        }

        .staff-fields,
        .signup-fields,
        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: all 0.5s ease-in-out;
            opacity: 0;
        }

        .staff-fields.expanded,
        .signup-fields.expanded {
            max-height: 200px;
            opacity: 1;
        }

        .animate-on-scroll {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }

        .animate-on-scroll.is-visible {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>

<body class="bg-white">

    <div id="loading-screen" class="h-screen w-screen flex flex-col justify-center items-center bg-white">
        <div class="loader"></div>
        <p class="mt-4 text-lg font-semibold text-gray-700">Connecting...</p>
    </div>

    <div id="home-screen" class="hidden">
        <div class="bg-gray-50">
            <header class="bg-white shadow-sm sticky top-0 z-20">
                <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-800">TransitFlow</h1>
                    <div>
                        <button id="home-login-btn"
                            class="bg-indigo-600 text-white px-5 py-2 rounded-full font-semibold hover:bg-indigo-700 transition-colors">Login
                            / Sign Up</button>
                        <button id="home-profile-btn"
                            class="hidden flex items-center space-x-2 text-gray-700 hover:text-indigo-600">
                            <span id="home-profile-name" class="font-semibold">My Profile</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                    </div>
                </nav>
            </header>
            <main>
                <section class="bg-indigo-700 text-white text-center py-20 px-6"
                    style="background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url(https://placehold.co/1920x1080/667eea/ffffff?text=City+Bus&font=inter); background-size: cover; background-position: center;">
                    <h2 class="text-5xl font-extrabold mb-4 animate-on-scroll">Welcome to Smart Transit</h2>
                    <p class="text-xl mb-8 max-w-2xl mx-auto animate-on-scroll" style="transition-delay: 100ms;">
                        Real-time tracking, easy ticketing, and transport planning. All in one place.</p>
                    <a href="#features"
                        class="bg-white text-indigo-600 px-8 py-4 rounded-full font-bold shadow-lg transform hover:scale-105 transition-transform animate-on-scroll"
                        style="transition-delay: 200ms;">Get Started</a>
                </section>
                <section id="features" class="py-20 bg-gray-50">
                    <div class="container mx-auto px-6">
                        <div class="text-center mb-12 animate-on-scroll">
                            <h2 class="text-4xl font-bold text-gray-800">Everything You Need</h2>
                            <p class="text-gray-600 mt-2">All the tools for a stress-free commute.</p>
                        </div>
                        <div class="grid md:grid-cols-3 gap-8">
                            <div
                                class="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-1 animate-on-scroll">
                                <h3 class="text-xl font-bold text-gray-800 mb-2">Track your Vehicle</h3>
                                <p class="text-gray-600 mb-4">See your bus move on the map in real-time. No more
                                    guessing, no more waiting.</p><button data-target="track-vehicle"
                                    class="feature-card-btn font-semibold text-indigo-600 hover:text-indigo-800 transition-colors">Track
                                    a Bus →</button>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-1 animate-on-scroll"
                                style="transition-delay: 100ms;">
                                <h3 class="text-xl font-bold text-gray-800 mb-2">Book Tickets</h3>
                                <p class="text-gray-600 mb-4">Purchase your bus tickets digitally. Skip the lines and go
                                    paperless.</p><button data-target="book-tickets"
                                    class="feature-card-btn font-semibold text-indigo-600 hover:text-indigo-800 transition-colors">Book
                                    Now →</button>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-1 animate-on-scroll"
                                style="transition-delay: 200ms;">
                                <h3 class="text-xl font-bold text-gray-800 mb-2">Find Transport</h3>
                                <p class="text-gray-600 mb-4">Enter your destination to see all available routes,
                                    timings, and fare estimates.</p><button data-target="find-transport"
                                    class="feature-card-btn font-semibold text-indigo-600 hover:text-indigo-800 transition-colors">Find
                                    a Route →</button>
                            </div>
                        </div>
                    </div>
                </section>
                <section class="py-20 bg-gray-50">
                    <div class="container mx-auto px-6 max-w-4xl">
                        <div class="text-center mb-12 animate-on-scroll">
                            <h2 class="text-4xl font-bold text-gray-800">Frequently Asked Questions</h2>
                        </div>
                        <div class="space-y-4">
                            <div class="bg-white rounded-lg shadow-md animate-on-scroll">
                                <div class="faq-question cursor-pointer p-6 flex justify-between items-center">
                                    <h3 class="text-lg font-semibold text-gray-800">Is this service free to use?</h3>
                                    <span class="text-indigo-500 transform transition-transform duration-300">▼</span>
                                </div>
                                <div class="faq-answer px-6 pb-6 text-gray-600">
                                    <p>Yes, the tracking and route finding features are completely free for all
                                        commuters. Standard charges may apply for booking tickets through the app.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
            <footer class="bg-gray-800 text-white py-6">
                <div class="container mx-auto px-6 text-center">
                    <p>&copy; 2025 TransitFlow. All Rights Reserved.</p>
                </div>
            </footer>
        </div>
    </div>

    <div id="auth-screen" class="hidden auth-container h-screen w-screen flex flex-col justify-center items-center p-4">
        <button id="auth-back-btn" class="absolute top-12 left-6 z-10">
            <p class="text-white text-lg">← Go Back</p>
        </button>
        <p class="text-5xl font-extrabold text-white mb-8">TransitFlow</p>
        <div class="w-full max-w-md bg-white/10 backdrop-blur-md p-8 rounded-2xl border border-white/20">
            <div class="mb-6">
                <div class="flex border border-white/30 rounded-lg p-1"><button data-role="traveller"
                        class="role-toggle-btn w-1/3 py-2 text-white rounded-md active">Traveller</button><button
                        data-role="driver"
                        class="role-toggle-btn w-1/3 py-2 text-white rounded-md">Driver</button><button
                        data-role="conductor"
                        class="role-toggle-btn w-1/3 py-2 text-white rounded-md">Conductor</button></div>
            </div>
            <h2 id="auth-title" class="text-3xl font-bold text-white text-center mb-6">Welcome Back</h2>
            <div id="auth-error-message" class="bg-red-500/50 text-white text-center p-2 rounded-lg mb-4 hidden"></div>
            <div class="space-y-4">
                <div id="signup-fields" class="signup-fields space-y-4"><input id="auth-fullname"
                        placeholder="Full Name"
                        class="w-full p-3 bg-white/20 text-white placeholder-gray-300 rounded-lg" type="text" /></div>
                <input id="auth-email" placeholder="Email Address"
                    class="w-full p-3 bg-white/20 text-white placeholder-gray-300 rounded-lg" type="email" />
                <input id="auth-password" placeholder="Password"
                    class="w-full p-3 bg-white/20 text-white placeholder-gray-300 rounded-lg" type="password" />
                <div id="signup-fields-confirm" class="signup-fields"><input id="auth-confirm-password"
                        placeholder="Confirm Password"
                        class="w-full p-3 bg-white/20 text-white placeholder-gray-300 rounded-lg" type="password" />
                </div>
                <div id="staff-fields" class="staff-fields space-y-4"><input id="auth-vehicle-number"
                        placeholder="Vehicle Number (e.g., KA01F1234)"
                        class="w-full p-3 bg-white/20 text-white placeholder-gray-300 rounded-lg uppercase"
                        type="text" /></div>
            </div>
            <button id="auth-submit-btn"
                class="w-full mt-6 py-3 bg-white rounded-lg flex justify-center items-center"><span
                    id="auth-submit-text" class="text-indigo-600 text-lg font-bold">Log In</span>
                <div id="auth-loader" class="loader hidden"></div>
            </button>
            <button id="auth-toggle-btn" class="w-full">
                <p class="text-white/80 text-center mt-6">Don't have an account? <span class="font-bold text-white">Sign
                        Up</span></p>
            </button>
        </div>
    </div>

    <div id="map-screen" class="hidden h-screen w-screen">
        <div id="map"></div>
        <div class="absolute top-0 left-0 right-0 p-4 pt-8 bg-gradient-to-b from-black/50 to-transparent z-[1000]">
            <div class="flex justify-between items-center">
                <button id="map-home-btn" class="bg-white/90 px-4 py-2 rounded-full shadow-lg font-semibold">←
                    Home</button>
                <button id="map-profile-btn" class="bg-white/90 px-4 py-2 rounded-full shadow-lg font-semibold">My
                    Profile</button>
            </div>
            <div id="route-buttons" class="mt-4 flex overflow-x-auto space-x-2 pb-2"></div>
        </div>
    </div>

    <div id="profile-screen" class="hidden h-screen w-screen bg-gray-100">
        <div class="container mx-auto max-w-2xl py-12 px-4">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800">My Profile</h1>
                <button id="profile-back-btn"
                    class="font-semibold text-indigo-600 hover:text-indigo-800 transition-colors">← Back to
                    Home</button>
            </div>
            <div class="bg-white p-8 rounded-lg shadow-md">
                <div class="space-y-4">
                    <div><label class="text-sm font-medium text-gray-500">Full Name</label>
                        <p id="profile-name" class="text-lg font-semibold text-gray-800">-</p>
                    </div>
                    <div><label class="text-sm font-medium text-gray-500">Email Address</label>
                        <p id="profile-email" class="text-lg font-semibold text-gray-800">-</p>
                    </div>
                </div>
                <hr class="my-6">
                <button id="profile-logout-btn"
                    class="w-full py-3 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition-colors">Logout</button>
            </div>
        </div>
    </div>

    <div id="book-tickets-screen" class="hidden h-screen w-screen bg-gray-100">
        <div class="container mx-auto max-w-2xl py-12 px-4">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800">Book a Ticket</h1>
                <button id="tickets-back-btn"
                    class="font-semibold text-indigo-600 hover:text-indigo-800 transition-colors">← Back to
                    Home</button>
            </div>
            <div class="bg-white p-8 rounded-lg shadow-md">
                <div class="space-y-4">
                    <div><label for="from-stop" class="text-sm font-medium text-gray-700">From</label><select
                            id="from-stop"
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></select></div>
                    <div><label for="to-stop" class="text-sm font-medium text-gray-700">To</label><select id="to-stop"
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></select></div>
                    <div><label for="travel-date" class="text-sm font-medium text-gray-700">Date of Travel</label><input
                            type="date" id="travel-date"
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></div>
                </div>
                <hr class="my-6">
                <button id="search-buses-btn"
                    class="w-full py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Search
                    Buses</button>
                <div id="ticket-results" class="mt-6"></div>
            </div>
        </div>
    </div>

    <div id="find-transport-screen" class="hidden h-screen w-screen bg-gray-100">
        <div class="container mx-auto max-w-2xl py-12 px-4">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800">Find Transport</h1>
                <button id="find-transport-back-btn"
                    class="font-semibold text-indigo-600 hover:text-indigo-800 transition-colors">← Back to
                    Home</button>
            </div>
            <div class="bg-white p-8 rounded-lg shadow-md">
                <div class="space-y-4">
                    <div><label for="pickup-location" class="text-sm font-medium text-gray-700">Pickup
                            Location</label><input type="text" id="pickup-location" placeholder="e.g., Central Station"
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></div>
                    <div><label for="drop-location" class="text-sm font-medium text-gray-700">Drop
                            Location</label><input type="text" id="drop-location" placeholder="e.g., Tech Park"
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></div>
                </div>
                <hr class="my-6">
                <button id="find-routes-btn"
                    class="w-full py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Find
                    Routes</button>
                <div id="find-transport-results" class="mt-6"></div>
            </div>
        </div>
    </div>

    <div id="track-vehicle-screen" class="hidden h-screen w-screen bg-gray-100">
        <div class="container mx-auto max-w-2xl py-12 px-4">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800">Track a Vehicle</h1>
                <button id="track-vehicle-back-btn"
                    class="font-semibold text-indigo-600 hover:text-indigo-800 transition-colors">← Back to
                    Home</button>
            </div>
            <div class="bg-white p-8 rounded-lg shadow-md">
                <div class="space-y-4">
                    <div><label for="vehicle-number-input" class="text-sm font-medium text-gray-700">Vehicle
                            Number</label><input type="text" id="vehicle-number-input" placeholder="e.g., KA01F1234"
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm uppercase"></div>
                </div>
                <hr class="my-6">
                <button id="track-vehicle-submit-btn"
                    class="w-full py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Track
                    Bus</button>
                <div id="track-vehicle-results" class="mt-4 text-center"></div>
                <div class="mt-6 text-center">
                    <p class="text-gray-600">Don't know the vehicle number?</p><button id="track-vehicle-find-route-btn"
                        class="font-semibold text-indigo-600 hover:text-indigo-800 transition-colors">Find a route
                        instead →</button>
                </div>
            </div>
        </div>
    </div>

    <div id="staff-profile-screen" class="hidden h-screen w-screen bg-gray-100">
        <div class="container mx-auto max-w-4xl py-12 px-4">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800">Staff Dashboard</h1>
                <button id="staff-profile-logout-btn"
                    class="font-semibold text-red-600 hover:text-red-800 transition-colors">Logout</button>
            </div>
            <div class="grid md:grid-cols-2 gap-8">
                <div class="bg-white p-8 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Details</h2>
                    <div class="space-y-4">
                        <div><label class="text-sm font-medium text-gray-500">Full Name</label>
                            <p id="staff-profile-name" class="text-lg font-semibold text-gray-800">-</p>
                        </div>
                        <div><label class="text-sm font-medium text-gray-500">Role</label>
                            <p id="staff-profile-role" class="text-lg font-semibold text-gray-800 capitalize">-</p>
                        </div>
                        <div><label class="text-sm font-medium text-gray-500">Assigned Vehicle</label>
                            <p id="staff-profile-vehicle" class="text-lg font-semibold text-gray-800">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-8 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Today's Route Assignment</h2>
                    <div class="space-y-4">
                        <div><label class="text-sm font-medium text-gray-500">Route</label>
                            <p id="staff-profile-route-name" class="text-lg font-semibold text-gray-800">-</p>
                        </div>
                        <div><label class="text-sm font-medium text-gray-500">Start / End Point</label>
                            <p id="staff-profile-route-points" class="text-lg font-semibold text-gray-800">-</p>
                        </div>
                        <div><label class="text-sm font-medium text-gray-500">Shift Time</label>
                            <p id="staff-profile-shift-time" class="text-lg font-semibold text-gray-800">08:00 AM -
                                05:00 PM</p>
                        </div>
                        <div><label class="text-sm font-medium text-gray-500">Daily Rounds</label>
                            <p id="staff-profile-rounds" class="text-lg font-semibold text-gray-800">8</p>
                        </div>
                        <div><label class="text-sm font-medium text-gray-500">Fare Rate</label>
                            <p id="staff-profile-fare" class="text-lg font-semibold text-gray-800">₹1.50 / km</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuration ---
            // IMPORTANT: Replace this with your DEPLOYED Render backend URL
            const API_URL = 'https://your-backend-url.onrender.com';

            // --- DOM Elements & App State ---
            const screens = { loading: document.getElementById('loading-screen'), home: document.getElementById('home-screen'), auth: document.getElementById('auth-screen'), map: document.getElementById('map-screen'), profile: document.getElementById('profile-screen'), 'book-tickets': document.getElementById('book-tickets-screen'), 'find-transport': document.getElementById('find-transport-screen'), 'track-vehicle': document.getElementById('track-vehicle-screen'), 'staff-profile': document.getElementById('staff-profile-screen') };
            let currentUser = null;
            let authMode = 'login';
            let authRole = 'traveller';

            // --- Core Functions ---
            function showScreen(screenName) {
                Object.values(screens).forEach(screen => screen.classList.add('hidden'));
                if (screens[screenName]) screens[screenName].classList.remove('hidden');
            }

            async function checkAuthState() {
                const token = localStorage.getItem('supabase_token');
                showScreen('loading');

                if (!token) {
                    updateUIForLoggedOutUser();
                    return;
                }

                try {
                    const res = await fetch(`${API_URL}/api/profile`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (res.ok) {
                        currentUser = await res.json();
                        updateUIForLoggedInUser();
                    } else {
                        localStorage.removeItem('supabase_token');
                        updateUIForLoggedOutUser();
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                    updateUIForLoggedOutUser();
                }
            }

            function updateUIForLoggedInUser() {
                const homeLoginBtn = document.getElementById('home-login-btn');
                const homeProfileBtn = document.getElementById('home-profile-btn');
                homeLoginBtn.classList.add('hidden');
                homeProfileBtn.classList.remove('hidden');

                const userData = currentUser.user.user_metadata;
                const userRole = userData.role || 'traveller';

                if (userRole === 'driver' || userRole === 'conductor') {
                    homeProfileBtn.querySelector('span').textContent = 'Staff Dashboard';
                    document.getElementById('staff-profile-name').textContent = userData.full_name;
                    document.getElementById('staff-profile-role').textContent = userRole;
                    document.getElementById('staff-profile-vehicle').textContent = userData.vehicle_number;
                } else {
                    homeProfileBtn.querySelector('span').textContent = userData.full_name || 'My Profile';
                    document.getElementById('profile-name').textContent = userData.full_name;
                    document.getElementById('profile-email').textContent = currentUser.user.email;
                }
                showScreen('home');
            }

            function updateUIForLoggedOutUser() {
                currentUser = null;
                document.getElementById('home-login-btn').classList.remove('hidden');
                document.getElementById('home-profile-btn').classList.add('hidden');
                showScreen('home');
            }

            function handleLogout() {
                localStorage.removeItem('supabase_token');
                updateUIForLoggedOutUser();
            }

            function updateAuthForm() {
                const signupFields = document.getElementById('signup-fields');
                const signupConfirmField = document.getElementById('signup-fields-confirm');
                const staffFields = document.getElementById('staff-fields');
                const authTitle = document.getElementById('auth-title');
                const authSubmitText = document.getElementById('auth-submit-text');
                const toggleText = document.getElementById('auth-toggle-btn').firstElementChild;

                if (authMode === 'signup') {
                    authTitle.textContent = 'Create Account';
                    authSubmitText.textContent = 'Sign Up';
                    toggleText.innerHTML = "Already have an account? <span class='font-bold text-white'>Log In</span>";
                    signupFields.classList.add('expanded');
                    signupConfirmField.classList.add('expanded');

                    if (authRole === 'driver' || authRole === 'conductor') {
                        staffFields.classList.add('expanded');
                    } else {
                        staffFields.classList.remove('expanded');
                    }
                } else { // Login Mode
                    authTitle.textContent = 'Welcome Back';
                    authSubmitText.textContent = 'Log In';
                    toggleText.innerHTML = "Don't have an account? <span class='font-bold text-white'>Sign Up</span>";
                    signupFields.classList.remove('expanded');
                    signupConfirmField.classList.remove('expanded');
                    staffFields.classList.remove('expanded');
                }
            }

            // --- Event Listeners ---
            checkAuthState();

            document.getElementById('auth-submit-btn').addEventListener('click', async () => {
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;
                const fullName = document.getElementById('auth-fullname').value;
                const confirmPassword = document.getElementById('auth-confirm-password').value;
                const vehicleNumber = document.getElementById('auth-vehicle-number').value;
                const authErrorMessage = document.getElementById('auth-error-message');

                const endpoint = authMode === 'login' ? '/api/login' : '/api/signup';
                let body = { email, password, fullName, role: authRole, vehicleNumber };

                authErrorMessage.classList.add('hidden');

                try {
                    const res = await fetch(API_URL + endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error);

                    localStorage.setItem('supabase_token', data.token);
                    await checkAuthState();
                } catch (error) {
                    console.error('Auth error:', error.message);
                    authErrorMessage.textContent = error.message;
                    authErrorMessage.classList.remove('hidden');
                }
            });

            document.getElementById('home-profile-btn').addEventListener('click', () => {
                if (!currentUser) return;
                const userRole = currentUser.user.user_metadata.role || 'traveller';
                if (userRole === 'driver' || userRole === 'conductor') {
                    showScreen('staff-profile');
                } else {
                    showScreen('profile');
                }
            });

            document.querySelectorAll('.role-toggle-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.role-toggle-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    authRole = btn.dataset.role;
                    updateAuthForm();
                });
            });

            document.getElementById('auth-toggle-btn').addEventListener('click', () => {
                authMode = authMode === 'login' ? 'signup' : 'login';
                updateAuthForm();
                document.getElementById('auth-error-message').classList.add('hidden');
                document.getElementById('auth-email').value = '';
                document.getElementById('auth-password').value = '';
                document.getElementById('auth-fullname').value = '';
                document.getElementById('auth-confirm-password').value = '';
            });

            document.getElementById('profile-logout-btn').addEventListener('click', handleLogout);
            document.getElementById('staff-profile-logout-btn').addEventListener('click', handleLogout);
            document.getElementById('auth-back-btn').addEventListener('click', () => showScreen('home'));
            document.getElementById('profile-back-btn').addEventListener('click', () => showScreen('home'));
            document.getElementById('tickets-back-btn').addEventListener('click', () => showScreen('home'));
            document.getElementById('find-transport-back-btn').addEventListener('click', () => showScreen('home'));
            document.getElementById('track-vehicle-back-btn').addEventListener('click', () => showScreen('home'));
            document.getElementById('home-login-btn').addEventListener('click', () => showScreen('auth'));
            document.querySelectorAll('.feature-card-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const targetScreen = e.target.dataset.target;
                if (currentUser) {
                    showScreen(targetScreen);
                } else {
                    showScreen('auth');
                }
            }));

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                    }
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.animate-on-scroll').forEach(el => {
                observer.observe(el);
            });
        });
    </script>
</body>

</html>